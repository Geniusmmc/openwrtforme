name: âš¡ï¸ å…¨èƒ½ç‰ˆ Image Builder (è‡ªåŠ¨é€‚é… zst/xz)

on:
  workflow_dispatch:
    inputs:
      force_version:
        description: 'å¡«å…¥ç‰ˆæœ¬å· (ä¾‹å¦‚ 24.10.4)ã€‚ç•™ç©ºåˆ™è‡ªåŠ¨èŽ·å– GitHub æœ€æ–°ç¨³å®šç‰ˆ'
        required: false
        default: ''

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # å¿…é¡»å®‰è£… zstd ä»¥è§£åŽ‹æ–°ç‰ˆå›ºä»¶
        sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3 zstd

    - name: Detect Version & Download
      run: |
        # 1. ç¡®å®šç‰ˆæœ¬å·
        if [ -n "${{ github.event.inputs.force_version }}" ]; then
          VERSION="${{ github.event.inputs.force_version }}"
          echo "ðŸ‘‰ ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ç‰ˆæœ¬: $VERSION"
        else
          # èŽ·å–æœ€æ–° Release Tag
          LATEST_TAG=$(curl -sL https://api.github.com/repos/immortalwrt/immortalwrt/releases/latest | grep "tag_name" | cut -d '"' -f 4)
          VERSION=${LATEST_TAG#v}
          echo "ðŸ”Ž è‡ªåŠ¨æ£€æµ‹åˆ° GitHub æœ€æ–°å‘å¸ƒç‰ˆ: $VERSION"
        fi

        # 2. æž„é€ åŸºç¡€ URL (x86/64)
        BASE_URL="https://downloads.immortalwrt.org/releases/${VERSION}/targets/x86/64"
        
        # 3. å°è¯•ä¸‹è½½é€»è¾‘ (ä¼˜å…ˆå°è¯• .zstï¼Œå¤±è´¥åˆ™å°è¯• .xz)
        FILE_ZST="immortalwrt-imagebuilder-${VERSION}-x86-64.Linux-x86_64.tar.zst"
        FILE_XZ="immortalwrt-imagebuilder-${VERSION}-x86-64.Linux-x86_64.tar.xz"
        
        echo "â¬‡ï¸ å°è¯•ä¸‹è½½æ–°ç‰ˆæ ¼å¼ (.zst)..."
        if wget -O ib.archive "$BASE_URL/$FILE_ZST"; then
          echo "âœ… ä¸‹è½½æˆåŠŸ (.zst)"
          EXT="zst"
        else
          echo "âš ï¸ .zst ä¸‹è½½å¤±è´¥ï¼Œå°è¯•æ—§ç‰ˆæ ¼å¼ (.xz)..."
          if wget -O ib.archive "$BASE_URL/$FILE_XZ"; then
            echo "âœ… ä¸‹è½½æˆåŠŸ (.xz)"
            EXT="xz"
          else
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç‰ˆæœ¬å· [$VERSION] æ˜¯å¦å­˜åœ¨ã€‚"
            exit 1
          fi
        fi

        # 4. è§£åŽ‹
        mkdir -p openwrt
        if [ "$EXT" == "zst" ]; then
          tar -I zstd -xf ib.archive -C openwrt --strip-components=1
        else
          tar -xf ib.archive -C openwrt --strip-components=1
        fi

    - name: Add OpenClash Source
      run: |
        cd openwrt
        mkdir -p packages/custom
        cd packages/custom
        
        # ä¸‹è½½ OpenClash IPK (æœ€æ–° Beta)
        wget https://github.com/vernesong/OpenClash/releases/download/v0.46.003-beta/luci-app-openclash_0.46.003-beta_all.ipk
        
        cd ../..
        # å…è®¸å®‰è£…æœ¬åœ°åŒ…
        sed -i 's/option check_signature/# option check_signature/g' repositories.conf

    - name: Configure IP & Packages
      run: |
        cd openwrt
        
        # --- 1. ä¿®æ”¹ IP ä¸º 10.0.0.1 ---
        sed -i 's/192.168.[0-9]*.[0-9]*/10.0.0.1/g' package/base-files/files/bin/config_generate
        
        # --- 2. è½¯ä»¶åŒ…é…ç½® ---
        # åŒ…å«: i915(æ ¸æ˜¾), igc(2.5Gç½‘å¡), OpenClash
        # æŽ’é™¤: æ—§ç½‘å¡é©±åŠ¨, dnsmasq(é˜²æ­¢å†²çª)
        
        PACKAGES="base-files block-mount ca-bundle default-settings-chn dnsmasq-full dropbear fdisk firewall4 fstools grub2-bios-setup \
        kmod-button-hotplug kmod-fs-f2fs kmod-igbvf kmod-igc kmod-ixgbevf kmod-nf-nathelper kmod-nf-nathelper-extra kmod-nft-offload kmod-usb-hid kmod-usb-net \
        luci-app-package-manager luci-compat luci-light mkf2fs mtd netifd nftables odhcp6c odhcpd-ipv6only opkg partx-utils ppp ppp-mod-pppoe procd-ujail uci uclient-fetch urandom-seed urngd \
        kmod-dwmac-intel kmod-fs-vfat kmod-drm-i915 i915-firmware-dmc \
        luci-app-openclash \
        -kmod-e1000e -kmod-e1000 -kmod-igb -kmod-i40e -kmod-ixgbe -dnsmasq"

        # --- 3. ç”Ÿæˆå›ºä»¶ ---
        make image PROFILE="generic" PACKAGES="$PACKAGES" PACKAGES_DIR="packages/custom" FILES="files"

    - name: Organize files
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt_Universal_x86_64
        path: ${{ env.FIRMWARE }}
        compression-level: 0
