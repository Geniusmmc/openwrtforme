name: Build ImmortalWrt

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-23.05
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4  # 已升级到 v4

    # --- 步骤：最大化磁盘空间 ---
    - name: Free Disk Space (Maximize)
      run: |
        echo "Freeing up disk space..."
        sudo -E apt-get -qq remove --purge azure-cli google-cloud-sdk dotnet* firefox google-chrome-stable powershell mono-devel
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/share/swift
        docker rmi $(docker images -q) 2>/dev/null
        df -hT

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$USER /workdir

    - name: Clone source code
      working-directory: /workdir
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Add OpenClash & Update Feeds
      run: |
        cd openwrt
        echo "src-git openclash https://github.com/vernesong/OpenClash.git" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure Firmware (IP & Packages)
      run: |
        cd openwrt
        
        # --- 1. 修改默认 IP 为 10.0.0.1 ---
        sed -i 's/192.168.[0-9]*.[0-9]*/10.0.0.1/g' package/base-files/files/bin/config_generate
        
        # --- 2. 生成基础配置 (x86_64) ---
        echo "CONFIG_TARGET_x86=y" > .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        
        # --- 3. 写入指定软件包 ---
        PACKAGES="autocore automount base-files block-mount ca-bundle default-settings-chn dnsmasq-full dropbear fdisk firewall4 fstools grub2-bios-setup i915-firmware-dmc kmod-button-hotplug kmod-fs-f2fs kmod-igbvf kmod-igc kmod-ixgbevf kmod-nf-nathelper kmod-nf-nathelper-extra kmod-nft-offload kmod-usb-hid kmod-usb-net libc libgcc libustream-openssl logd luci-app-package-manager luci-compat luci-lib-base luci-lib-ipkg luci-light mkf2fs mtd netifd nftables odhcp6c odhcpd-ipv6only opkg partx-utils ppp ppp-mod-pppoe procd-ujail uci uclient-fetch urandom-seed urngd kmod-dwmac-intel kmod-fs-vfat kmod-drm-i915 luci-app-openclash"
        
        for pkg in $PACKAGES; do
            echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done

        # --- 4. 显式禁用不需要的驱动 ---
        echo "# CONFIG_PACKAGE_kmod-e1000e is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-e1000 is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-igb is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-i40e is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ixgbe is not set" >> .config
        
        # --- 5. 解决冲突 ---
        echo "# CONFIG_PACKAGE_dnsmasq is not set" >> .config
        
        make defconfig

    - name: Download package
      id: package
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organize files
      id: organize
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware directory
      uses: actions/upload-artifact@v4  # 已升级到 v4 (关键修复)
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware
        path: ${{ env.FIRMWARE }}
        compression-level: 0 # v4 新特性：设置为0可以加快上传速度（因为固件本身已经是压缩包）
