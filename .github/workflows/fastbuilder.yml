name: ğŸŸ¢ æœ€ç»ˆå®Œç¾ä¿®å¤ç‰ˆ (Image Builder)

on:
  workflow_dispatch:
    inputs:
      force_version:
        description: 'å¯é€‰: æ‰‹åŠ¨å¡«å…¥ç‰ˆæœ¬å· (å¦‚ 24.10.4)ã€‚ç•™ç©ºåˆ™è‡ªåŠ¨è·å–æœ€æ–°ç¨³å®šç‰ˆ'
        required: false
        default: ''

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # æ ¸å¿ƒä¿®å¤: æ·»åŠ  qemu-utils è§£å†³ qcow2 ç”Ÿæˆå¤±è´¥çš„é—®é¢˜
        sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3 zstd qemu-utils

    - name: Detect Version & Download
      run: |
        # 1. ç¡®å®šç‰ˆæœ¬å·
        if [ -n "${{ github.event.inputs.force_version }}" ]; then
          VERSION="${{ github.event.inputs.force_version }}"
          echo "ğŸ‘‰ ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ç‰ˆæœ¬: $VERSION"
        else
          # è·å–æœ€æ–° Release Tag
          LATEST_TAG=$(curl -sL https://api.github.com/repos/immortalwrt/immortalwrt/releases/latest | grep "tag_name" | cut -d '"' -f 4)
          VERSION=${LATEST_TAG#v}
          echo "ğŸ” è‡ªåŠ¨æ£€æµ‹åˆ° GitHub æœ€æ–°å‘å¸ƒç‰ˆ: $VERSION"
        fi

        # 2. æ„é€ ä¸‹è½½é“¾æ¥
        BASE_URL="https://downloads.immortalwrt.org/releases/${VERSION}/targets/x86/64"
        FILE_ZST="immortalwrt-imagebuilder-${VERSION}-x86-64.Linux-x86_64.tar.zst"
        FILE_XZ="immortalwrt-imagebuilder-${VERSION}-x86-64.Linux-x86_64.tar.xz"
        
        echo "â¬‡ï¸ å‡†å¤‡ä¸‹è½½ Image Builder..."
        if wget -O ib.archive "$BASE_URL/$FILE_ZST"; then
          echo "âœ… ä¸‹è½½æˆåŠŸ (.zst)"
          EXT="zst"
        else
          echo "âš ï¸ .zst ä¸‹è½½å¤±è´¥ï¼Œå°è¯•æ—§ç‰ˆæ ¼å¼ (.xz)..."
          if wget -O ib.archive "$BASE_URL/$FILE_XZ"; then
            echo "âœ… ä¸‹è½½æˆåŠŸ (.xz)"
            EXT="xz"
          else
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç‰ˆæœ¬å· [$VERSION] æ˜¯å¦å­˜åœ¨ã€‚"
            exit 1
          fi
        fi

        # 3. è§£å‹
        mkdir -p openwrt
        if [ "$EXT" == "zst" ]; then
          tar -I zstd -xf ib.archive -C openwrt --strip-components=1
        else
          tar -xf ib.archive -C openwrt --strip-components=1
        fi

    - name: Add OpenClash Source
      run: |
        cd openwrt
        mkdir -p packages/custom
        cd packages/custom
        
        # ä¸‹è½½ OpenClash IPK
        wget https://github.com/vernesong/OpenClash/releases/download/v0.46.003-beta/luci-app-openclash_0.46.003-beta_all.ipk
        
        cd ../..
        sed -i 's/option check_signature/# option check_signature/g' repositories.conf

    - name: Configure IP & Packages
      run: |
        cd openwrt
        
        # --- æ ¸å¿ƒ: ä½¿ç”¨ uci-defaults ä¿®æ”¹ IP (è§£å†³ sed æŠ¥é”™) ---
        mkdir -p files/etc/uci-defaults
        cat << EOF > files/etc/uci-defaults/99-custom-ip
        uci set network.lan.ipaddr='10.0.0.1'
        uci commit network
        exit 0
        EOF
        chmod +x files/etc/uci-defaults/99-custom-ip

        # --- è½¯ä»¶åŒ…é…ç½® ---
        # åŒ…å«: i915, igc, OpenClash
        # æ’é™¤: æ—§é©±åŠ¨
        
        PACKAGES="base-files block-mount ca-bundle default-settings-chn dnsmasq-full dropbear fdisk firewall4 fstools grub2-bios-setup \
        kmod-button-hotplug kmod-fs-f2fs kmod-igbvf kmod-igc kmod-ixgbevf kmod-nf-nathelper kmod-nf-nathelper-extra kmod-nft-offload kmod-usb-hid kmod-usb-net \
        luci-app-package-manager luci-compat luci-light mkf2fs mtd netifd nftables odhcp6c odhcpd-ipv6only opkg partx-utils ppp ppp-mod-pppoe procd-ujail uci uclient-fetch urandom-seed urngd \
        kmod-dwmac-intel kmod-fs-vfat kmod-drm-i915 i915-firmware-dmc \
        luci-app-openclash \
        -kmod-e1000e -kmod-e1000 -kmod-igb -kmod-i40e -kmod-ixgbe -dnsmasq"

        # --- ç”Ÿæˆå›ºä»¶ ---
        make image PROFILE="generic" PACKAGES="$PACKAGES" PACKAGES_DIR="packages/custom" FILES="files"

    - name: Organize files
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt_Final_x86_64
        path: ${{ env.FIRMWARE }}
        compression-level: 0
