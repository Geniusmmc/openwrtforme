name: ğŸ§¹ çº¯å‡€ç‰ˆ Image Builder (ä»… EFI é•œåƒ)

on:
  workflow_dispatch:
    inputs:
      force_version:
        description: 'å¯é€‰: æ‰‹åŠ¨å¡«å…¥ç‰ˆæœ¬å· (å¦‚ 24.10.4)ã€‚ç•™ç©ºåˆ™è‡ªåŠ¨è·å–æœ€æ–°ç¨³å®šç‰ˆ'
        required: false
        default: ''

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # å³ä½¿æˆ‘ä»¬åªéœ€è¦ img.gzï¼ŒImage Builder ç¼–è¯‘è¿‡ç¨‹ä»ä¼šå°è¯•æ‰“åŒ… ISO/QCOW2
        # æ‰€ä»¥å¿…é¡»å®‰è£…è¿™äº›å·¥å…·é˜²æ­¢ç¼–è¯‘ä¸­é€”æŠ¥é”™ (Error 127)
        sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3 zstd qemu-utils genisoimage xorriso

    - name: Detect Version & Download
      run: |
        # 1. ç¡®å®šç‰ˆæœ¬å·
        if [ -n "${{ github.event.inputs.force_version }}" ]; then
          VERSION="${{ github.event.inputs.force_version }}"
          echo "ğŸ‘‰ ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ç‰ˆæœ¬: $VERSION"
        else
          LATEST_TAG=$(curl -sL https://api.github.com/repos/immortalwrt/immortalwrt/releases/latest | grep "tag_name" | cut -d '"' -f 4)
          VERSION=${LATEST_TAG#v}
          echo "ğŸ” è‡ªåŠ¨æ£€æµ‹åˆ° GitHub æœ€æ–°å‘å¸ƒç‰ˆ: $VERSION"
        fi

        # 2. ä¸‹è½½å¹¶è§£å‹
        BASE_URL="https://downloads.immortalwrt.org/releases/${VERSION}/targets/x86/64"
        FILE_ZST="immortalwrt-imagebuilder-${VERSION}-x86-64.Linux-x86_64.tar.zst"
        FILE_XZ="immortalwrt-imagebuilder-${VERSION}-x86-64.Linux-x86_64.tar.xz"
        
        if wget -O ib.archive "$BASE_URL/$FILE_ZST"; then
          EXT="zst"
        elif wget -O ib.archive "$BASE_URL/$FILE_XZ"; then
          EXT="xz"
        else
          echo "âŒ ä¸‹è½½å¤±è´¥ï¼"
          exit 1
        fi

        mkdir -p openwrt
        if [ "$EXT" == "zst" ]; then
          tar -I zstd -xf ib.archive -C openwrt --strip-components=1
        else
          tar -xf ib.archive -C openwrt --strip-components=1
        fi

    - name: Add OpenClash Source
      run: |
        cd openwrt
        mkdir -p packages/custom
        cd packages/custom
        wget https://github.com/vernesong/OpenClash/releases/download/v0.46.003-beta/luci-app-openclash_0.46.003-beta_all.ipk
        cd ../..
        sed -i 's/option check_signature/# option check_signature/g' repositories.conf

    - name: Configure IP & Packages
      run: |
        cd openwrt
        
        # --- 1. ä½¿ç”¨ uci-defaults ä¿®æ”¹ IP (10.0.0.1) ---
        mkdir -p files/etc/uci-defaults
        cat << EOF > files/etc/uci-defaults/99-custom-ip
        uci set network.lan.ipaddr='10.0.0.1'
        uci commit network
        exit 0
        EOF
        chmod +x files/etc/uci-defaults/99-custom-ip

        # --- 2. è½¯ä»¶åŒ…é…ç½® (æ ¸æ˜¾ + 2.5Gç½‘å¡ + OpenClash - æ—§é©±åŠ¨) ---
        PACKAGES="base-files block-mount ca-bundle default-settings-chn dnsmasq-full dropbear fdisk firewall4 fstools grub2-bios-setup \
        kmod-button-hotplug kmod-fs-f2fs kmod-igbvf kmod-igc kmod-ixgbevf kmod-nf-nathelper kmod-nf-nathelper-extra kmod-nft-offload kmod-usb-hid kmod-usb-net \
        luci-app-package-manager luci-compat luci-light mkf2fs mtd netifd nftables odhcp6c odhcpd-ipv6only opkg partx-utils ppp ppp-mod-pppoe procd-ujail uci uclient-fetch urandom-seed urngd \
        kmod-dwmac-intel kmod-fs-vfat kmod-drm-i915 i915-firmware-dmc \
        luci-app-openclash \
        -kmod-e1000e -kmod-e1000 -kmod-igb -kmod-i40e -kmod-ixgbe -dnsmasq"

        # --- 3. ç”Ÿæˆå›ºä»¶ ---
        make image PROFILE="generic" PACKAGES="$PACKAGES" PACKAGES_DIR="packages/custom" FILES="files"

    - name: Extract Only EFI Image
      run: |
        cd openwrt/bin/targets/*/*
        
        # åˆ›å»ºä¸€ä¸ªè¾“å‡ºæ–‡ä»¶å¤¹
        mkdir -p final_output
        
        # --- æ ¸å¿ƒæ­¥éª¤ï¼šåªç§»åŠ¨ Combined-EFI é•œåƒ ---
        # æŸ¥æ‰¾åŒ…å« combined-efi.img.gz çš„æ–‡ä»¶å¹¶ç§»åŠ¨åˆ°è¾“å‡ºç›®å½•
        mv *combined-efi.img.gz final_output/ 2>/dev/null || true
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
        if [ -z "$(ls -A final_output)" ]; then
           echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° EFI é•œåƒï¼å¯èƒ½æ˜¯ç¼–è¯‘å¤±è´¥æˆ–æ–‡ä»¶åå˜æ›´ã€‚"
           ls -lh  # åˆ—å‡ºå½“å‰æ–‡ä»¶ä»¥ä¾¿è°ƒè¯•
           exit 1
        fi
        
        echo "âœ… æˆåŠŸæå– EFI é•œåƒ"
        echo "FIRMWARE=$PWD/final_output" >> $GITHUB_ENV

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt_EFI_Only
        path: ${{ env.FIRMWARE }}
        compression-level: 0
